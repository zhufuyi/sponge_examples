
## Overview

This example demonstrates how to use Sponge to generate a gRPC service and integrate it with DTM (Distributed Transaction Management) and service registration and discovery (e.g., etcd, Consul, Nacos).

<br>

### Building the Transfer Service

The transfer service (gRPC) code is automatically generated by [Sponge](https://github.com/zhufuyi/sponge) (select `â“¸Create grpc service based on protobuf`). After generation, fill in the transfer-related business logic in the template code file (e.g., `internal/service/transfer.go`).

The image below shows the code generation interface:

![sponge-dtm-service-registration-discovery](https://raw.githubusercontent.com/zhufuyi/sponge_examples/main/assets/en_sponge-dtm-service-registration-discovery.png)

UnZip file, navigate to the project root directory (e.g., the transfer directory) and run the following commands to generate the code:

```bash
# Generate code
make proto

# Open the internal/service/transfer.go file and add business logic according to the generated sample code.

# Compile and start the service
make run
```

For more detailed documentation on creating gRPC services with Sponge, refer to: [Sponge gRPC Development Documentation](https://go-sponge.com/zh-cn/microservice-development-protobuf).

**Key Implementation Code:**

- Import the `dtmdriver-sponge` driver at line 9 in [internal/rpcclient/dtmservice.go](internal/rpcclient/dtmservice.go).
- Submit the two-phase message transaction at line 65 in [internal/service/transfer.go](internal/service/transfer.go).

<br>

### Compiling DTM

Clone the DTM project code and compile it to get the DTM binary file.

```bash
git clone https://github.com/dtm-labs/dtm.git
cd dtm
go build

# Copy a sample configuration for DTM
cp conf.sample.yml conf.yml
```

Note: The main branch of DTM already includes the Sponge driver, but since it's not yet released in the latest version, you need to clone the main branch of DTM to compile it locally.

<br>

### Using etcd for Service Discovery

Follow these steps to use etcd for service registration and discovery:

1. **Start etcd Service**
    - Ensure that the etcd service is running locally or in the target environment.

2. **Configure DTM Service**
    - Modify the DTM configuration file `conf.yml` to register the service with etcd:
      ```yaml
      MicroService:
        Driver: 'dtm-driver-sponge'
        Target: 'etcd://127.0.0.1:2379/dtmservice'
        EndPoint: 'grpc://127.0.0.1:36790'
      ```

3. **Start DTM Service**
    - Start DTM using the following command:
      ```bash
      dtm -c conf.yml
      ```

4. **Configure Transfer Service**
    - Update the `configs/transfer.yml` configuration file and set `registryDiscoveryType` to etcd to enable service registration and discovery:
      ```yaml
      app:
        registryDiscoveryType: "etcd"  # Service registration and discovery types: consul, etcd, nacos. If empty, registration and discovery are not used.
 
      grpcClient:
        - name: "dtmservice"          # DTM service name for service discovery
          registryDiscoveryType: "etcd"  # Service registration and discovery types: consul, etcd, nacos. If empty, direct connection using host and port
          host: "127.0.0.1"             # DTM service address; ignored if service discovery is enabled
          port: 36790                    # DTM service port; ignored if service discovery is enabled
 
      etcd:
        addrs: ["127.0.0.1:2379"]
      ```

5. **Start Transfer Service**
    - Compile and run the transfer service:
      ```bash
      cd cmd/transfer
      go run main.go
      
      # or
      make run
      ```

6. **Test the Service**
    - Open the generated gRPC client test code `internal/service/transfer_client_test.go` and fill in the test parameters, for example:
      ```go
      {
          name: "Transfer",
          fn: func() (interface{}, error) {
              // Fill in the test parameters
              req := &transferV1.TransferRequest{
                  Amount:     100,
                  FromUserId: 1,
                  ToUserId:   2,
              }
              return cli.Transfer(ctx, req)
          },
          wantErr: false,
      }
      ```
    - In a new terminal, navigate to the `internal/service` directory and run the following command to test:
      ```bash
      go test -run Test_service_transfer_methods/Transfer
      ```
    - **Tip**: If using `Goland IDE`, open the code `internal/service/transfer_client_test.go`, and click the green button on the left to run the test directly.

<br>

### Using Consul for Service Registration and Discovery

1. Ensure that the Consul service is running locally or in the target environment.

2. Open the `configs/transfer.yml` configuration file for the transfer service and change `registryDiscoveryType` under both `app` and `grpcClient` sections to `consul`. Then, fill in the address under the `consul` section.

3. Modify the DTM service configuration file `conf.yml`, updating the `Target` field under `MicroService` to the Consul address (e.g., `consul://127.0.0.1:8500/dtmservice`).

4. Restart both the DTM and transfer services, and test whether the API calls function correctly.

<br>

### Using Nacos for Service Registration and Discovery

1. Ensure that the Nacos service is running locally or in the target environment.

2. Open the `configs/transfer.yml` configuration file for the transfer service, change `registryDiscoveryType` under both `app` and `grpcClient` sections to `nacos`, and fill in the address and `namespaceID` under the `nacos` section.

3. Modify the DTM service configuration file `conf.yml`, updating the `Target` field under `MicroService` to the Nacos address (e.g., `nacos://127.0.0.1:8848/dtmservice?namespaceID=xxx`).

4. Restart both the DTM and transfer services, and test whether the API calls function correctly.

**Note**: The `namespaceID` in both the DTM and transfer configuration files must match. The default `namespaceID` is `public`. If a different value is specified, ensure it is consistently updated in all relevant configurations.
